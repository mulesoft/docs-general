= Partner Guide for Upgrading and Testing Custom Connectors for Java 17

NOTE: This guide applies only to MuleSoft partners.

Upgrade and test your custom connectors for Java 17 to ensure compatibility within the MuleSoft ecosystem. 

== Before You Begin

Before upgrading and testing your custom connector for Java 17, you must be familiar with the following:

* *Running and compiling your custom connector*
+
Ensure your custom connector runs with Java 17, but always use Java 8 as the target compilation level.
+
Because you must compile your custom connector with Java 8, use the Java compiler configuration from the Java SDK parent POM. You can’t use language features from Java 11 or Java 17. 

* *Avoiding -add-opens or -add-export directives*
+
Do not set -add-opens or -add-export directives.

* *Understanding minimum Mule version caveats*
+
If your custom connector has a minimum Mule version that is incompatible with Java 17 (Mule 4.5.x and earlier), you can’t run Java 17 tests that extend the MuleArtifactFunctionalTestCase. You can still run Java 8 tests.
+
To decouple the minimum Mule version when running tests, add the -Dmunit.jvm parameter to use Java 17 as described in <<test-for-java-17-compatibility-directly>>.

== Upgrade Your Custom Connector

The steps to upgrade differ depending on how your connector is developed. 

* <<upgrade-your-mule-sdk-connectors>> (Java SDK and XML SDK)
* <<upgrade-your-rest-sdk-connectors>>
* <<upgrade-your-rest-connect-connectors>> 

[[upgrade-your-mule-sdk-connectors]]
=== Upgrade Your Mule SDK Connectors

Upgrade your Mule SDK (Java SDK and XML SDK) connectors to Java 17:

==== Upgrade Third-Party Libraries

Upgrade your custom connector’s third-party libraries to be compatible with Java 17.

===== Upgrade Java EE Libraries

Mule 4.6 exposes Java EE libraries differently. You must add the following BOM dependency to your custom connector and, if applicable, ensure the provided conflicting library is properly excluded. You can also add the libraries in the BOM dependency separately.

[source,java,linenums]
----
<muleJavaEeBomVersion>4.6.0-20231025</muleJavaEeBomVersion>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.mule</groupId>
        <artifactId>mule-javaee-runtime-bom</artifactId>
        <version>${muleJavaEeBomVersion}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
----

===== Upgrade External Libraries

Upgrade external libraries, which are third-party libraries that are not bundled with your custom connector. Some examples include a JDBC driver, JMS broker client, or Groovy runtime. The following example shows a JDBC driver external library configuration: 

[source,java,linenums]
----
@ExternalLib(name = "MySQL JDBC Driver",
description = "A JDBC driver that supports connection to the MySQL Database",
nameRegexpMatcher = "(.*)\\.jar",
requiredClassName = "com.mysql.jdbc.Driver",
coordinates = "mysql:mysql-connector-java:5.1.44")
public class MySqlConnectionProvider implements ConnectionProvider<Connection> {
  //
}
----

You must update your external libraries to a version that is compatible with Java 17. 

==== Review Your Code

Even though you compile your custom connector with Java 8, ensure you can run your custom connector with Java 17. Reviewing your code is important because there are some restrictions that are flagged as warnings in Java 11 but are flagged as failures and can’t be disabled in Java 17. For example, reflection is more restricted in Java 17, so you must review your code to ensure there are no illegal actions. 

Learn about the different changes in Java 17 to review your code effectively.

===== JDK Migration Guide

See the https://docs.oracle.com/en/java/javase/17/migrate/getting-started.html#GUID-C25E2B1D-6C24-4403-8540-CFEA875B994A[Oracle JDK Migration Guide]. It contains a full list of the changes made in Java 17. Use the guide to assess impact to your code.

===== Mule Runtime Changes

See <<LINK TO MULE RUNTIME>>. It contains a full list of the Java 17 changes made in Mule Runtime. 

* <<Reflection on Java classes>> 
* <<Serialization>>
* <<Library upgrades>>
* <<Changes with running the test suite>>? 
* <<JPMS>>
// link to these docs which will be in the Mule Runtime docs

=== Add Missing Code

Because reflection is more restricted in Java 17, API objects now require setters. Previously, API objects and plain old Java objects (POJOs) had default constructors and getters for all properties. Now, API objects and POJOs must also have setters so DataWeave can build outside the connector in the Mule app. 

Constructors and setters are required if your class is instantiated, and getters are required if your class is read. If your class is returned and not instantiated, only getters are required. However, using both getters and setters simplify the validation and certification process. 

=== Upgrade Your REST SDK Connectors

Upgrade your REST SDK connectors to Java 17 by using the REST SDK 0.8.0-RC4 version. 

0.8.0-RC4 generates Java 17 compatible connectors and maintains backward compatibility only with 0.8.0-RC3 connectors built without Java customizations. 0.8.0-RC4 is not backward compatible with REST SDK versions earlier than 0.8.0-RC3. 

When upgrading REST SDK connectors to Java 17:

* For connectors with versions earlier than 0.8.0-RC3, or connectors with version 0.8.0-RC3 with Java customizations:
+
Regenerate the connector with 0.8.0-RC4 and port over any Java customizations. The resulting connector will likely break compatibility with the previous version of the connector.

* For connectors with version 0.8.0-RC3 without Java customizations:
+
When you regenerate the connector with 0.8.0-RC4, the resulting connector will be backward compatible with the previous version.

For more information about REST SDK, see https://beta.docs.mulesoft.com/beta-mule-sdk/mule-sdk/1.1/rest-sdk/rest-sdk-connectivity[REST SDK]. 

==== Upgrade an Existing REST SDK Connector

If you previously generated a connector using REST SDK and you want to make that connector compatible with Java 17:

. Upgrade the REST SDK components and dependencies to 0.8.0-RC4.
+
[source,java,linenums]
----
<parent>
   <groupId>com.mulesoft.connectivity</groupId>
   <artifactId>rest-sdk-connector-parent-pom</artifactId>
   <version>0.8.0-RC4</version>
</parent>

<rest.sdk.commons.version>0.8.0-RC4</rest.sdk.commons.version>
<rest.sdk.mojo.version>0.8.0-RC4</rest.sdk.mojo.version>
----
. If you manually create the configuration class (ConnectorNameConfiguration.java) using the REST SDK overriding feature, you must add an extra annotation. 
+
[source,java,linenums]
----
import org.mule.sdk.api.annotation.JavaVersionSupport;
import org.mule.sdk.api.meta.JavaVersion;

@JavaVersionSupport({JavaVersion.JAVA_8, JavaVersion.JAVA_11, JavaVersion.JAVA_17})

public class YourConnectorConfiguration
----
. Regenerate the connector.

==== Upgrade a New REST SDK Connector

If you generate a new connector using REST SDK and want to make that connector compatible with Java 17:

. Upgrade the REST SDK components and dependencies to 0.8.0-RC4.
+
[source,java,linenums]
----
<parent>
   <groupId>com.mulesoft.connectivity</groupId>
   <artifactId>rest-sdk-connector-parent-pom</artifactId>
   <version>0.8.0-RC4</version>
</parent>

<rest.sdk.commons.version>0.8.0-RC4</rest.sdk.commons.version>
<rest.sdk.mojo.version>0.8.0-RC4</rest.sdk.mojo.version>
---- 
. Upgrade the Mule runtime version to 4.6.0.

=== Upgrade Your REST Connect Connectors 

Upgrade your REST Connect connectors to Java 17.

REST Connect now supports Java 17. REST Connect connectors are generated from an API specification using REST Connect, so all you have to do to make the connector Java 17-compatible is republish the API specification to Exchange. See https://docs.mulesoft.com/exchange/to-deploy-using-rest-connect[REST Connect Connector Generator].

IMPORTANT: REST Connect now adds support for TLS. To save time, you can enable TLS at the same time with the Java 17 upgrade. This way, you only need to generate the connector and test your apps once.
 
== Test Your Connector with MTF

Test your custom connector with Module Testing Framework (MTF) to ensure Java 17 compatibility. For more information about MTF, see https://beta.docs.mulesoft.com/beta-mtf/mule-sdk/1.1/mtf[MTF]. 

=== Set Up Your Build

Ensure your pipeline runs against all supported Java versions (Java 8, Java 11, and Java 17). The following example shows a single build pipeline that is configured to run tests against all supported Java versions, in which `default` corresponds to Java 17:

image:single-build-pipeline.png[Example of single build pipeline]

The pipeline runs all tests even if the previous tests fail. For example, the pipeline runs Java 17 tests even if the Java 11 tests fail. 

Although there are multiple tests, the pipeline has one compilation phase and one release phase which target Java 8.

=== Run Your Tests

Run MTF tests to ensure your custom connector is compatible with Java 17.

==== Run an Initial Test

Run an initial test to test your custom connector for Java 17 compatibility. You can continue to run tests as you change your custom connector’s code.

. 
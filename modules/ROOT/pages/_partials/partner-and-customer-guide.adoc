// Partial used for common content in the Java 17 partner and customer guides

// tag::partner-upgrade-note[]

NOTE: This guide applies to MuleSoft partners only. If you are a MuleSoft customer, see xref:customer-connector-upgrade.adoc[].

// end::partner-upgrade-note[]

// tag::customer-upgrade-note[]

NOTE: This guide applies to MuleSoft customers only. If you are a MuleSoft partner, see xref:partner-connector-upgrade.adoc[].

// end::customer-upgrade-note[]

// tag::connector-intro[]

Upgrade, test, and release your custom connectors for Java 17 to ensure compatibility within the MuleSoft ecosystem. 

// end::connector-intro[]

// tag::min-mule-version-mtf[]

* Minimum Mule version
+
If your custom connector is running on Mule 4.5.x or earlier, you can’t run Java 17 tests that extend the `MuleArtifactFunctionalTestCase`, but you can still run Java 8 tests.
+
To decouple the minimum Mule version when running tests, add the `-Dmunit.jvm` parameter to use Java 17 as described in <<test-for-java-17-compatibility-directly>>.

// end::min-mule-version-mtf[]

// tag::min-mule-version-munit[]

* Minimum Mule version
+
If your custom connector is running on Mule 4.5.x or earlier, you can’t run Java 17 tests that extend the `MuleArtifactFunctionalTestCase`, but you can still run Java 8 tests.
+
To decouple the minimum Mule version when running tests, add the `-Dmunit.jvm` parameter to use Java 17 as described in <<test-your-custom-connector-with-munit>>.

// end::min-mule-version-munit[]

// tag::before-you-begin[]

== Before You Begin

Before upgrading and testing your custom connector for Java 17, you must be familiar with the following considerations:

* Target compilation level
+
NOTE: The maximum supported version for running your applications is Java 17 for Mule runtime 4.6.x and later. During the packaging of your app, all code, including third-party dependencies, *must* be compiled for Java 8.
+
Because you must compile your custom connector with Java 8, use the Java compiler configuration from the Java SDK parent POM. You can’t use language features from Java 11 or Java 17. 

* Unsupported directives
+
Do not set `-add-opens` or `-add-export` directives.


// end::before-you-begin[]

// tag::mule-sdk-connectors[]

[[upgrade-your-mule-sdk-connectors]]
== Upgrade Your Custom Mule SDK Connectors

Upgrade your custom Mule SDK (Java SDK and XML SDK) connectors to Java 17.

[[upgrade-third-party-libraries]]
=== Upgrade Third-Party Libraries

Upgrade the third-party libraries of your custom connector to be compatible with Java 17:

* Java EE libraries
+
Mule 4.6.x exposes Java EE libraries differently than earlier Mule versions. You must add the BOM dependency to your custom connector and, if applicable, exclude the provided conflicting library. You can also add the libraries in the BOM dependency separately.
+
[source,java,linenums]
----
<muleJavaEeBomVersion>4.6.0</muleJavaEeBomVersion>
  <dependencyManagement>
    <dependencies>
      <dependency>
        <groupId>org.mule</groupId>
        <artifactId>mule-javaee-runtime-bom</artifactId>
        <version>${muleJavaEeBomVersion}</version>
        <type>pom</type>
        <scope>import</scope>
      </dependency>
    </dependencies>
  </dependencyManagement>
----
+
For more information, see xref:mule-sdk::java-ee-libraries.adoc[].

* External libraries
+
Upgrade external libraries, which are third-party libraries that are not bundled with your custom connector. Some examples include a JDBC driver, JMS broker client, or Groovy runtime. The following example shows a JDBC driver external library configuration: 
+
[source,java,linenums]
----
@ExternalLib(name = "MySQL JDBC Driver",
description = "A JDBC driver that supports connection to the MySQL Database",
nameRegexpMatcher = "(.*)\\.jar",
requiredClassName = "com.mysql.jdbc.Driver",
coordinates = "mysql:mysql-connector-java:5.1.44")
public class MySqlConnectionProvider implements ConnectionProvider<Connection> {
  //
}
----
+
You must update your external libraries to a version that is compatible with Java 17. 

=== Review Your Code

After you compile your custom connector with Java 8, ensure you can run your custom connector with Java 17. Reviewing your code is important because some restrictions are flagged as warnings in Java 11 but are flagged as failures and can’t be disabled in Java 17. For example, reflection is more restricted in Java 17, so you must review your code to ensure there are no illegal actions. 

To help you review your code, learn more about the different changes in Java 17:

* JDK Migration Guide
+
See the https://docs.oracle.com/en/java/javase/17/migrate/getting-started.html#GUID-C25E2B1D-6C24-4403-8540-CFEA875B994A[Oracle JDK Migration Guide] for a full list of the changes made in Java 17. Use the guide to assess the impact to your code.

// end::mule-sdk-connectors[]

// tag::mule-sdk-connectors-review-mule-runtime[]

* Mule runtime engine
+
See xref:java-support.adoc#mule-runtime[Mule runtime] to learn more about the Java 17 changes made in Mule runtime engine. 
+
** Reflection on Java classes
** Serialization
** Library upgrades
** Changes with running the test suite
** JPMS

// end::mule-sdk-connectors-review-mule-runtime[]

// tag::mule-sdk-connectors-review-mule-runtime-sdk[]

* Mule runtime engine
+
See xref:general::java-support.adoc#mule-runtime[Mule runtime] to learn more about the Java 17 changes made in Mule runtime engine. 
+
** Reflection on Java classes
** Serialization
** Library upgrades
** Changes with running the test suite
** JPMS

// end::mule-sdk-connectors-review-mule-runtime-sdk[]

// tag::mule-sdk-connectors-add-missing-code[]

=== Add Missing Code

Because reflection is more restricted in Java 17, API objects now require setters. Previously, API objects and plain old Java objects (POJOs) had default constructors and getters for all properties. Now, API objects and POJOs must also have setters so DataWeave can build outside the connector in the Mule app. 

Constructors and setters are required if your class is instantiated, and getters are required if your class is read. If your class is returned and not instantiated, only getters are required. However, using both getters and setters simplify the validation and certification process. 

// end::mule-sdk-connectors-add-missing-code[]

// tag::rest-connect-connectors[]

[[upgrade-your-rest-connect-connectors]]
== Upgrade Your Custom REST Connect Connectors 

Upgrade your custom REST Connect connectors to Java 17.

REST Connect now supports Java 17. REST Connect connectors are generated from an API specification using REST Connect. To make the connector Java 17-compatible, republish the API specification to Exchange. See xref:exchange::to-deploy-using-rest-connect.adoc[REST Connect Connector Generator].

IMPORTANT: REST Connect now adds support for TLS. To save time, enable TLS at the same time you update your generated connector for Java 17 so that you need to generate the connector and test your apps only once.

// end::rest-connect-connectors[]

// tag::custom-configuration-properties-provider-partners[]

[[upgrade-your-custom-configuration-properties-providers]]
== Upgrade Your Custom Configuration Properties Providers

To upgrade your custom configuration properties provider to be compatible with Java 17, you have two alternatives:

. It is best to switch to use xref:mule-sdk::getting-started.adoc[Java SDK] and use the `@JavaVersionSupport` annotation as explained in xref:general::partner-connector-upgrade.adoc#release-your-custom-connector[Release Your Custom Connector]. You can also perform all the other steps described in xref:general::partner-connector-upgrade.adoc[], just like with any custom connector. The example custom configuration properties provider mentioned in xref:mule-runtime::custom-configuration-properties-provider.adoc#example-mule-sdk-module[Example: Mule SDK Module] is updated to support Java 17, so you can refer to that example to update your custom configuration properties provider. For more details about what the changed code looks like (including migrating tests to MUnit), refer to this https://github.com/mulesoft/mule-custom-properties-providers-module-example/commit/410ee26d8b3c44adacb077e099f32886f99eb6be[changeset]. 

. If switching to using xref:mule-sdk::getting-started.adoc[Java SDK] involves too many changes for you, add a declaration using `ExtensionDeclarer` inside `ExtensionLoadingDelegate` in your custom configuration properties provider. For more details about what the changed code looks like, refer to this https://github.com/mulesoft/mule-custom-properties-providers-module-example/commit/19d9d45cd52b0695f7b9c2b9019bae88f45fb228[changeset].

// end::custom-configuration-properties-provider-partners[]

// tag::custom-configuration-properties-provider-customers[]

[[upgrade-your-custom-configuration-properties-providers]]
== Upgrade Your Custom Configuration Properties Providers

To upgrade your custom configuration properties provider to be compatible with Java 17, you have two alternatives:

. It is best to switch to use xref:mule-sdk::getting-started.adoc[Java SDK] and use the `@JavaVersionSupport` annotation as explained in xref:general::customer-connector-upgrade.adoc#release-your-custom-connector[Release Your Custom Connector]. You can also perform all the other steps described in xref:general::customer-connector-upgrade.adoc[], just like with any custom connector. The example custom configuration properties provider mentioned in xref:mule-runtime::custom-configuration-properties-provider.adoc#example-mule-sdk-module[Example: Mule SDK Module] is updated to support Java 17, so you can refer to that example to update your custom configuration properties provider. For more details about what the changed code looks like (including migrating tests to MUnit), refer to this https://github.com/mulesoft/mule-custom-properties-providers-module-example/commit/410ee26d8b3c44adacb077e099f32886f99eb6be[changeset]. 

. If switching to using xref:mule-sdk::getting-started.adoc[Java SDK] involves too many changes for you, add a declaration using `ExtensionDeclarer` inside `ExtensionLoadingDelegate` in your custom configuration properties provider. For more details about what the changed code looks like, refer to this https://github.com/mulesoft/mule-custom-properties-providers-module-example/commit/19d9d45cd52b0695f7b9c2b9019bae88f45fb228[changeset].

// end::custom-configuration-properties-provider-customers[]

// tag::communicate-support-level[]

[[release-your-custom-connector]]
== Release Your Custom Connector

After you update your code and your tests are green, you are ready to release a new Java 17-compatible version of your custom connector. 

. To communicate Java 17 compatibility, generate metadata for Java compatibility of your custom connector by adding or upgrading the custom connector `mule-sdk-api` dependency to the latest version: 
+
[source,xml,linenums]
----
<dependency>
   <groupId>org.mule.sdk</groupId>
   <artifactId>mule-sdk-api</artifactId>
   <version>0.7.0</version>
</dependency>
----

. For Java SDK, add the `@JavaVersionSupport` annotation in the same class as the `@Extension` annotation and include the `JAVA_17` value, for example: 
+
NOTE: You don't need to add any annotations for XML SDK because XML SDK modules are Java 17 compatible and inherit the property automatically.
+
[source,java,linenums]
----
@Extension(name = "Database")
@Operations(...)
@JavaVersionSupport({JAVA_8, JAVA_11, JAVA_17})
public class DatabaseConnector {
..
}
----

In Mule 4.5.0 and later, custom connectors that do not specify the `@JavaVersionSupport` annotation are assumed to be compatible with Java 8 and Java 11.

You can mark your custom connector as compatible with Java 17 only; however, you must ensure that no adoption or backward compatibility issues exist. 

When you deploy a Mule app, Mule verifies that all modules in the Mule app are compatible with the Java version. If Mule finds an incompatibility, Mule throws an error and the application does not deploy. 

NOTE: If you receive an error message specific to an XML SDK based connector, such as `Extension 'module-error-handler-plugin' does not support Java 17. Supported versions are: [1.8, 11]`, this means that your Mule app still contains some connectors that are not compatible with Java 17. To resolve this error, upgrade all connectors in your Mule app to be compatible with Java 17.

If your code is compatible with Java 17 but you do not declare Java 17 compatibility, you can still get a successful test run. 

To run a quick check on your custom connector or if all dependencies are not ready, pass the following argument to skip hard checks on the Java support declaration:

[source,bash]
----
-M-Dmule.jvm.version.extension.enforcement=LOOSE
----

For more information, see xref:mule-sdk::java-version-support.adoc[].

// end::communicate-support-level[]

// tag::test-custom-connector-mtf[]

[[test-your-custom-connector-with-mtf]]
== Test Your Custom Connector with MTF

Test your custom connector with Module Testing Framework (MTF) to ensure Java 17 compatibility. For more information about MTF, see https://beta.docs.mulesoft.com/beta-mtf/mule-sdk/1.1/mtf[MTF]. 

=== Set Up Your Build

Ensure your pipeline runs against all supported Java versions (Java 8, Java 11, and Java 17). The following example shows a single build pipeline that is configured to run tests against all supported Java versions, in which `default` corresponds to Java 17:

image:single-build-pipeline.png[Example of single build pipeline]

The pipeline runs all tests even if the previous tests fail. For example, the pipeline runs Java 17 tests even if the Java 11 tests fail. 

Although the pipeline contains multiple tests, the pipeline has one compilation phase and one release phase, which targets Java 8.

=== Run an Initial Test

Run an initial test to test your custom connector for Java 17 compatibility. You can continue to run tests as you change the custom connector code:

. In the `pom.xml` file of your custom connector, update the munit-extensions-maven-plugin configuration to include the following configuration (the `jacoco.version` property must be 0.8.10 or later): 
+
[source,xml,linenums]
----
<argLines>
         <argLine>                      -javaagent:${settings.localRepository}/org/jacoco/org.jacoco.agent/${jacoco.version}/org.jacoco.agent-${jacoco.version}-runtime.jar=destfile=${session.executionRootDirectory}/target/jacoco-munit.exec</argLine>
</argLines>
----
. Run your MTF test to generate the coverage report.

=== View your Coverage Report

View your coverage report to see your custom connector coverage. You must have at least 80% coverage for a high certainty of Java 17 compatibility. 

. Open IntelliJ IDEA.
. Go to *Run* > *Show Coverage Data*.
. In *Choose Coverage Suite to Display*, add `jacoco-munit.exec` to the list if it's not there already.
. Look at the coverage percentages to analyze your results.

=== Add the JDeps Maven Plugin

JDeps is a tool for static code analysis that detects the usage of JDK internal APIs that are no longer available or accessible. For more information, refer to the https://wiki.openjdk.org/display/JDK8/Java+Dependency+Analysis+Tool[OpenJDK wiki]. 

Add the JDeps Maven plugin to your custom connector’s `pom.xml` file:

[source,xml,linenums]
----
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-jdeps-plugin</artifactId>
    <version>3.1.2</version>
    <executions>
        <execution>
            <goals>
               <goal>jdkinternals</goal> <!-- verify main classes -->
               <goal>test-jdkinternals</goal> <!-- verify test classes -->
            </goals>
        </execution>
    </executions>
    <configuration>
        <failOnWarning>true</failOnWarning>
    </configuration>
</plugin>
----

=== Test for Java 17 Compatibility 

You can test for Java 17 compatibility running on either Java 11 or Java 17. 

If you are running on Java 11, you can perform early validations by adding a parameter for illegal reflective access. See <<add-a-parameter-for-illegal-reflective-access>>.

If you are running on Java 17, you can test for Java 17 directly. See <<test-for-java-17-compatibility-directly>>.

[[add-a-parameter-for-illegal-reflective-access]]
==== Add a Parameter for Illegal Reflective Access

Reflective access is one of the breaking changes of Java 17. If you run your MTF tests with the default Java 11 behavior, the MTF tests log only a warning for reflective access. 

To resemble Java 17 behavior, run your MTF tests with the `--illegal-access=deny` JVM parameter so the MTF tests fail instead of logging only a warning. Use this parameter in Mule runtime versions 4.2.0 and later.

To set up your custom connector’s `pom.xml` file to include the configuration:

. Add an empty property:
+
[source,xml,linenums]
----
<mtf.javaopts></mtf.javaopts>
----
. Update the munit-extensions-maven-plugin configuration to include the following configuration:
+
[source,xml,linenums]
----
<environmentVariables>
   <!-- Toggles the JDK17 style flag -->
   <_JAVA_OPTIONS>-XX:+PrintCommandLineFlags ${mtf.javaopts}</_JAVA_OPTIONS>
</environmentVariables>
----

You can now run your MTF tests with the `--illegal-access=deny` parameter. Here is an example bash script: 

[source,bash]
----
#!/bin/bash
RUNTIME_VERSION=4.6.0
MUNIT_JVM=/Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home/bin/java
mvn clean
mkdir target 
mvn verify \
    -DruntimeProduct=MULE_EE \
    -DruntimeVersion=$RUNTIME_VERSION \
    -Dmunit.jvm=$MUNIT_JVM \
    -Dmtf.javaopts="--illegal-access=deny" > ./target/test.log
----

After running your MTF tests, go to the `target/illegal-access.log` file and check for classes or dependencies that misbehave. 

You can also use the following command to exclude the known warnings outside of your custom connector: 

[source,bash]
----
cat target/illegal-access.log | sort | uniq | grep -Ev "org.mule.module.artifact|org.mule.metadata|org.mule.runtime|org.mule.service"
----

[[test-for-java-17-compatibility-directly]]
==== Test for Java 17 Compatibility Directly

Run your MTF tests to test compatibility of your custom connector against Java 17. 

As mentioned previously, you can use a single build pipeline that runs against all supported Java versions. You can also set up another temporary build pipeline for Java 17 so your main build pipeline doesn't become unstable. After you upgrade to Java 17, discard the temporary build pipeline and converge on your main build pipeline.

. Set the path to your JVM installation in the `MUNIT_JVM` variable (you must install it yourself). You must also set `JAVA_HOME` to Java 8. 
. Ensure the following MTF dependencies are set in your custom connector `pom.xml` file:
+
* munit 3.1.0
* munit-extensions-maven-plugin 1.2.0
* mtf-tools 1.2.0
* mule-maven-plugin 4.1.0
* mule-extensions-maven-plugin 1.6.0-rc1

These MTF dependencies require a minimum Mule version of 4.3.0. To ensure your MTF tests don't validate against Mule runtime versions earlier than 4.3.0, add the following to the `munit-plugin` configuration in your custom connector `pom.xml` file: 

[source,xml,linenums]
----
<configuration>
	[...]
<runtimeConfiguration>
    <discoverRuntimes>
        <minMuleVersion>${minVersion}</minMuleVersion>
        <includeSnapshots>false</includeSnapshots>
        <product>EE</product>
    </discoverRuntimes>
</runtimeConfiguration>
</configuration>
----

You can run MTF tests against Java 17 only with Mule runtime 4.6.0 and later. For Mule runtime 4.5.x and earlier, you can run MTF tests only against Java 8 and Java 11. 

MUnit 3.1 is compatible only with Mule runtime 4.3.0 and later. If your connector is compatible with Mule runtime 4.2.0 and earlier, you must create a legacy profile that overrides the MUnit version.

Use the following bash script to test your custom connector against Java 17: 

[source,bash]
----
#!/bin/bash
RUNTIME_VERSION=4.6.0
MUNIT_JVM=/Library/Java/JavaVirtualMachines/temurin-17.jdk/Contents/Home/bin/java
mvn clean
mkdir target
mvn verify \
   -DruntimeProduct=MULE_EE \
   -DruntimeVersion=$RUNTIME_VERSION \
   -Dmunit.jvm=$MUNIT_JVM \
   -Dmule.module.tweaking.validation.skip=true \
   -Dmule.jvm.version.extension.enforcement=LOOSE > ./target/test.log
----

The Mule runtime version you use determines the version of the mule-modules-parent. For example, if you use Mule runtime 4.6.0, you must use mule-modules-parent 1.6.0. Minor versions maintain a correspondence, such as Mule runtime 4.1.0 with mule-modules parent 1.1.0, Mule runtime 4.2.0 with mule-modules-parent 1.2.0, and so forth.

Java 17 is supported with Mule runtime 4.6.0 and later. However, a connector can be compatible with both Mule 4.3.0 and Java 17 simultaneously. If your connector must be compatible with Mule 4.3.0, its mule-modules-parent version cannot exceed 1.3.0. You do not necessarily need to use mule-modules-parent 1.6.0 for your connector to be compatible with Java 17. Using mule-modules-parent 1.6.0 is specifically required to leverage other features from the Mule runtime 4.6.0 in the connector.

=== Read Your Tests 

After you run your MTF tests, your build has either of the following outcomes:

* Test failures
+
You probably need to change your custom connector code to ensure Java 17 compatibility.

* All tests pass
+
Either your custom connector does not require any major changes or your test suite is not comprehensive enough. Review your test suite and double-check that your code coverage is good and that your test scenarios and assertions are not too simple.

// end::test-custom-connector-mtf[]

// tag::test-custom-connector-munit[]

[[test-your-custom-connector-with-munit]]
== Test Your Custom Connector with MUnit

Run your MUnit tests to test compatibility of your connector against Java 17. Ensure your local JDK version is 17. 

. Open the pom.xml file of your Mule app.
. Replace the `mule-maven-plugin` version with the `${mule.maven.plugin.version}` parameter.
. If you haven’t already, add the `munit-maven-plugin`. Replace the version with the `${munit.version}` parameter and replace `runtimeVersion` with the `${app.runtime}` parameter.
+
[source,xml,linenums]
----
	<plugin>
		<groupId>com.mulesoft.munit.tools</groupId>
		<artifactId>munit-maven-plugin</artifactId>
		<version>${munit.version}</version>
		<executions>
			<execution>
				<id>test</id>
				<phase>test</phase>
				<goals>
					<goal>test</goal>
					<goal>coverage-report</goal>
				</goals>
			</execution>
		</executions>
		<configuration>
			<coverage>
				<runCoverage>true</runCoverage>
				<formats>
					<format>html</format>
				</formats>
			</coverage>
			<runtimeVersion>${app.runtime}</runtimeVersion>
			<dynamicPorts>
				<dynamicPort>http.port</dynamicPort>
			</dynamicPorts>
		</configuration>
	</plugin>
----
+
NOTE: MUnit 3.1 is compatible only with Mule runtime 4.3.0 and later. If your connector is compatible with Mule runtime 4.2.0 and earlier, you must create a legacy profile that overrides the MUnit version.
. If you have MUnit dependencies, such as `munit-runner` and `munit-tools`, replace the version for each dependency with the `${munit-version}` parameter.
. Replace the version for each connector dependency with the Java 17 compatible version of the connector.
. Open a terminal window in the root of your Mule project and run the following command:
+
[source,bash]
----
mvn -f pom.xml -s ~/.m2/settings.xml -Dapp.runtime=4.6.0 -Dmunit.version=3.1.0 -Dmule.maven.plugin.version=4.1.0 -fae test
----

You can now see if your connector is compatible with Java 17. For more information about running MUnit tests, refer to xref:munit::index.adoc[MUnit]. 

The Mule runtime version you use determines the version of the mule-modules-parent. For example, if you use Mule runtime 4.6.0, you must use mule-modules-parent 1.6.0. Minor versions maintain a correspondence, such as Mule runtime 4.1.0 with mule-modules parent 1.1.0, Mule runtime 4.2.0 with mule-modules-parent 1.2.0, and so forth.

Java 17 is supported with Mule runtime 4.6.0 and later. However, a connector can be compatible with both Mule 4.3.0 and Java 17 simultaneously. If your connector must be compatible with Mule 4.3.0, its mule-modules-parent version cannot exceed 1.3.0. You do not necessarily need to use mule-modules-parent 1.6.0 for your connector to be compatible with Java 17. Using mule-modules-parent 1.6.0 is specifically required to leverage other features from the Mule runtime 4.6.0 in the connector.

// end::test-custom-connector-munit[]

// tag::see-also[]

== See Also

* xref:java-support.adoc[]

// end::see-also[]

// tag::see-also-sdk[]

== See Also

* xref:general::java-support.adoc[]

// end::see-also-sdk[]
